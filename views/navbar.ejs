<nav class="er-navbar">
    <div class="er-navbar-inner">

        <!-- LEFT: Logo + (Desktop) Menu -->
        <div class="er-navbar-left">
            <a href="/" class="er-navbar-logo">
                <img src="/img/logo-no-bg.png" alt="Ella Rises Logo">
            </a>

            <!-- DESKTOP & MOBILE MENU -->
            <ul class="er-navbar-menu" id="mobileMenu">
                <% const isManager=session && session.access_level && (session.access_level.toLowerCase()==="manager" ||
                    session.access_level.toLowerCase()==="admin" ); const isLoggedIn=session && session.isLoggedIn;
                    const menus=[ { label: "EVENTS" , href: "/events" }, { label: "REGISTER" , items: [ {
                    text: "Registrations" , href: "/registrations" }, { text: "Participants" , href: "/participants" },
                    { text: "Milestones" , href: "/milestones" } ] } ]; if (isLoggedIn) { menus.push({ label: "SURVEY" ,
                    items: [ { text: "Surveys" , href: "/surveys" }, { text: "Dashboard" , href: "/dashboard" } ] }); }
                    %>

                    <% menus.forEach(menu=> { %>
                        <% if (menu.href) { %>
                            <li class="nav-item">
                                <a href="<%= menu.href %>" class="er-nav-link">
                                    <%= menu.label %>
                                </a>
                            </li>
                            <% } else { %>
                                <li class="nav-item dropdown">
                                    <a href="#" class="er-nav-link dropdown-toggle" data-dropdown-toggle>
                                        <%= menu.label %>
                                    </a>
                                </li>
                                <li class="nav-item dropdown-items-container">
                                    <ul class="dropdown-menu">
                                        <% menu.items.forEach(item=> { %>
                                            <li>
                                                <a class="dropdown-item" href="<%= item.href %>">
                                                    <%= item.text %>
                                                </a>
                                            </li>
                                            <% }) %>
                                    </ul>
                                </li>
                                <% } %>
                                    <% }) %>

                                        <!-- DONATE (styled as link in mobile) -->
                                        <li class="nav-item er-navbar-donate-wrapper">
                                            <a class="er-navbar-donate" href="/donations/new">DONATE</a>
                                        </li>

                                        <!-- MOBILE ONLY - LOGIN (only visible if not logged in) -->
                                        <% if (!isLoggedIn) { %>
                                            <li class="nav-item mobile-login-item">
                                                <a href="/auth/login" class="er-nav-link">LOGIN</a>
                                            </li>
                                            <% } %>

                                                <!-- MOBILE ONLY - ADMIN TOOLS (only visible if logged in as admin) -->
                                                <% if (isLoggedIn && isManager) { %>
                                                    <li class="nav-item mobile-admin-dropdown">
                                                        <a href="#" class="er-nav-link dropdown-toggle"
                                                            data-dropdown-toggle>
                                                            ADMIN TOOLS
                                                        </a>
                                                    </li>
                                                    <li class="nav-item dropdown-items-container mobile-admin-dropdown">
                                                        <ul class="dropdown-menu">
                                                            <li><a class="dropdown-item" href="/users">Manage Users</a>
                                                            </li>
                                                            <li><a class="dropdown-item" href="/donations">Manage
                                                                    Donations</a></li>
                                                        </ul>
                                                    </li>
                                                    <% } %>

                                                        <!-- MOBILE ONLY - LOGOUT (only visible if logged in) -->
                                                        <% if (isLoggedIn) { %>
                                                            <li class="nav-item mobile-logout-item">
                                                                <a href="/auth/logout" class="er-nav-link">LOGOUT</a>
                                                            </li>
                                                            <% } %>
            </ul>
        </div>

        <!-- RIGHT: Desktop Login / Username -->
        <div class="er-navbar-right">
            <% if (!isLoggedIn) { %>
                <a href="/auth/login" class="er-nav-link">LOGIN</a>
                <% } else { %>
                    <div class="nav-item dropdown er-account-dropdown">
                        <a class="er-nav-link dropdown-toggle" href="#">
                            <%= session.firstname || session.username %>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end">
                            <% if (isManager) { %>
                                <li><a class="dropdown-item" href="/users">Manage Users</a></li>
                                <li><a class="dropdown-item" href="/donations">Manage Donations</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <% } %>
                                    <li><a class="dropdown-item" href="/auth/logout">Logout</a></li>
                        </ul>
                    </div>
                    <% } %>
        </div>

        <!-- MOBILE HAMBURGER -->
        <div class="er-navbar-hamburger" id="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>

    </div>
</nav>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const hamburger = document.getElementById("hamburger");
        const menu = document.getElementById("mobileMenu");

        // Toggle hamburger menu
        hamburger.addEventListener("click", () => {
            hamburger.classList.toggle("active");
            menu.classList.toggle("open");
            document.body.style.overflow = menu.classList.contains("open") ? "hidden" : "";
        });

        // Check if we're in mobile view
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // Toggle mobile dropdown accordion (click/tap)
        document.querySelectorAll("[data-dropdown-toggle]").forEach(toggle => {
            // Click handler for mobile
            toggle.addEventListener("click", (e) => {
                if (isMobile()) {
                    e.preventDefault();
                    e.stopPropagation();
                    const dropdownParent = toggle.closest(".dropdown, .mobile-admin-dropdown");
                    dropdownParent.classList.toggle("open");
                }
            });

            // Hover handler for split-screen desktop mode
            const dropdownParent = toggle.closest(".dropdown, .mobile-admin-dropdown");
            if (dropdownParent) {
                dropdownParent.addEventListener("mouseenter", () => {
                    if (isMobile()) {
                        dropdownParent.classList.add("open");
                    }
                });

                dropdownParent.addEventListener("mouseleave", () => {
                    if (isMobile()) {
                        dropdownParent.classList.remove("open");
                    }
                });
            }
        });

        // Close mobile menu when clicking navigation links (but not dropdown toggles)
        document.querySelectorAll(".er-navbar-menu a:not([data-dropdown-toggle])").forEach(link => {
            link.addEventListener("click", () => {
                if (menu.classList.contains("open")) {
                    hamburger.classList.remove("active");
                    menu.classList.remove("open");
                    document.body.style.overflow = "";

                    // Close any open dropdowns
                    document.querySelectorAll(".dropdown.open").forEach(dropdown => {
                        dropdown.classList.remove("open");
                    });
                }
            });
        });

        // Close dropdowns when clicking outside
        document.addEventListener("click", (e) => {
            if (isMobile() && !e.target.closest(".dropdown") && !e.target.closest(".mobile-admin-dropdown") && !e.target.closest(".er-navbar-hamburger")) {
                document.querySelectorAll(".dropdown.open, .mobile-admin-dropdown.open").forEach(dropdown => {
                    dropdown.classList.remove("open");
                });
            }
        });
    });
</script>