<nav class="er-navbar">
<div class="er-navbar-inner">

    <div class="er-navbar-left">
        <a href="/" class="er-navbar-logo">
            <img src="/img/logo-no-bg.png" alt="Ella Rises Logo">
        </a>

        <ul class="er-navbar-menu">
            <% 
            // 1. Define Manager Status safely (Case Insensitive)
            // Checks if session exists, has access_level, and if it matches 'manager' or 'admin'
            const isManager = session && session.access_level && (session.access_level.toLowerCase() === "manager" || session.access_level.toLowerCase() === "admin");

            const menus = [
                { label: "EVENTS", items: [
                    { text: "Events", href: "/events" },
                    { text: "Event Occurrences", href: "/eventOccurrences" }
                ]},
                { label: "REGISTER", items: [
                    { text: "Registrations", href: "/registrations" },
                    { text: "Participants", href: "/participants" },
                    { text: "Milestones", href: "/milestones" }
                ]},
                { label: "SURVEY", items: [
                    { text: "Surveys", href: "/surveys" },
                    // 2. Add 'restricted: true' flag to Dashboard so we know to hide it
                    { text: "Dashboard", href: "/dashboard", restricted: true } 
                ]}
            ]; 
            %>

            <% menus.forEach(menu => { %>
                <li class="nav-item dropdown">
                    <a class="er-nav-link nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <%= menu.label %>
                    </a>

                    <ul class="dropdown-menu">
                        <% menu.items.forEach(i => { %>
                            
                            <% // 3. The Logic Check: If item is restricted and user is NOT manager, skip it. %>
                            <% if (i.restricted && !isManager) return; %>

                            <li>
                                <a class="dropdown-item" href="<%= i.href %>">
                                    <%= i.text %>
                                </a>
                            </li>
                        <% }) %>
                    </ul>
                </li>
            <% }) %>

            <a class="er-navbar-donate" href="/donations/new">DONATE</a>
        </ul>
    </div>

    <div class="er-navbar-right">
        <% if (!session || !session.isLoggedIn) { %>
            <a href="/auth/login" class="er-navbar-login">LOGIN</a>
        <% } else { %>
            <div class="nav-item dropdown er-account-dropdown">
                <a class="er-nav-link nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                    <%= session.username %>
                </a>
            
                <ul class="dropdown-menu dropdown-menu-end">
                    <% // Use the same safe check here as well %>
                    <% if (isManager) { %>
                        <li><a class="dropdown-item" href="/users">Manage Users</a></li>
                        <li><a class="dropdown-item" href="/donations">Manage Donations</a></li>
                        <li><hr class="dropdown-divider"></li>
                    <% } %>
                    
                    <li><a class="dropdown-item" href="/auth/logout">Logout</a></li>
                </ul>
            </div>

        <% } %>
    </div>

</div>
</nav>