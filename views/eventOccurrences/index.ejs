<section class="page-container">
    <div class="container-inner">

        <!-- HEADER -->
        <div class="container-header">
            <h1 class="page-title">Scheduled Events</h1>
            <div class="heading-underline"></div>
        </div>

        <% 
            // Standardized, robust manager check
            const role = (session.role || (session.user && session.user.role) || "").toLowerCase();
            const isManager = role === "manager" || role === "admin";
        %>

        <!-- TABLE CONTROLS -->
        <%- include("../partials/tableControls", {
            showAddButton: isManager,
            addHref: "/eventOccurrences/new",
            addLabel: "Schedule New Occurrence",
            searchAction: "/eventOccurrences",
            searchPlaceholder: "Search event, type, or location…",
            query: q        // q should be passed from your route (req.query.q)
        }) %>

        <!-- CLEARED SEARCH INDICATOR -->
        <% if (q) { %>
            <p class="search-clear">
                Showing results for "<strong><%= q %></strong>"
                — <a href="/eventOccurrences">Clear</a>
            </p>
        <% } %>

        <!-- TABLE OR EMPTY MESSAGE -->
        <% if (!occurrences || occurrences.length === 0) { %>

            <p>No scheduled events found.</p>

        <% } else { %>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Capacity</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        <% occurrences.forEach(o => { %>
                            <tr>
                                <td><strong><%= o.event_name %></strong></td>

                                <td>
                                    <%= new Date(o.starts_at).toLocaleString() %>
                                </td>

                                <td><%= o.event_type %></td>
                                <td><%= o.location %></td>
                                <td><%= o.capacity %></td>

                                <td class="table-actions">
                                    <a href="/eventOccurrences/<%= o.event_occurrence_id %>" 
                                       class="btn btn-outline btn-table">
                                        View
                                    </a>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

        <% } %>

    </div>
</section>
