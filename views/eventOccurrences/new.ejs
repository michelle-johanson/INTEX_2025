<div class="page-container">
    <div class="page-card-form">
        <h2>Schedule New Event Occurrence</h2>

        <% if (typeof errors !== 'undefined' && Object.keys(errors).length > 0) { %>
            <div class="alert alert-danger">
                <p><strong>Please correct the following issues:</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <% for (const key in errors) { %>
                        <li><%= errors[key] %></li>
                    <% } %>
                </ul>
            </div>
        <% } %>

        <form action="/eventOccurrences/new" method="POST" class="form">

            <!-- EVENT TEMPLATE SELECT -->
            <label for="EventID">Event Template (Required)</label>
            <select id="EventID" 
                    name="EventID" 
                    required 
                    class="<%= errors.EventID ? 'input-error' : '' %>">

                <option value="" disabled 
                    <%= !selectedEventId && !formData.EventID ? 'selected' : '' %>>
                    Select an event…
                </option>

                <% 
                    const currentSelection = formData.EventID || selectedEventId;
                %>

                <% events.forEach(e=> { %>
                    <% const isSelected = (String(currentSelection) === String(e.event_id)); %>
                    <option value="<%= e.event_id %>" <%= isSelected ? 'selected' : '' %>>
                        <%= e.name %> — <%= e.event_type %>
                    </option>
                <% }) %>
            </select>

            <% if (errors.EventID) { %>
                <p class="error-text"><%= errors.EventID %></p>
            <% } %>

            <!-- START DATETIME -->
            <label for="EventDateTimeStart">Start Date & Time</label>
            <input 
                id="EventDateTimeStart"
                type="datetime-local"
                name="EventDateTimeStart"
                value="<%= formData.EventDateTimeStart || '' %>"
                required
                class="<%= errors.StartsAt ? 'input-error' : '' %>"
            />
            <% if (errors.StartsAt) { %>
                <p class="error-text"><%= errors.StartsAt %></p>
            <% } %>

            <!-- END DATETIME -->
            <label for="EventDateTimeEnd">End Date & Time</label>
            <input 
                id="EventDateTimeEnd"
                type="datetime-local"
                name="EventDateTimeEnd"
                value="<%= formData.EventDateTimeEnd || '' %>"
            />

            <!-- LOCATION -->
            <label for="EventLocation">Location</label>
            <input 
                id="EventLocation"
                type="text"
                name="EventLocation"
                value="<%= formData.EventLocation || '' %>"
                required
            />

            <!-- CAPACITY -->
            <label for="EventCapacity">Capacity</label>
            <input 
                id="EventCapacity"
                type="number"
                min="1"
                name="EventCapacity"
                value="<%= formData.EventCapacity || '' %>"
                required
                class="<%= errors.EventCapacity ? 'input-error' : '' %>"
            />
            <% if (errors.EventCapacity) { %>
                <p class="error-text"><%= errors.EventCapacity %></p>
            <% } %>

            <!-- REGISTRATION DEADLINE -->
            <label for="EventRegistrationDeadline">Registration Deadline</label>
            <input 
                id="EventRegistrationDeadline"
                type="date"
                name="EventRegistrationDeadline"
                value="<%= formData.EventRegistrationDeadline || '' %>"
            />

            <!-- BUTTONS -->
            <div class="btn-wrapper">
                <button type="submit" class="btn btn-primary btn-lg">Create Occurrence</button>

                <% 
                    const cancelId = selectedEventId || formData.EventID;
                %>

                <% if (cancelId) { %>
                    <a href="/events/<%= cancelId %>" class="btn btn-secondary btn-lg">
                        Cancel
                    </a>
                <% } else { %>
                    <a href="/eventOccurrences" class="btn btn-secondary btn-lg">
                        Cancel
                    </a>
                <% } %>
            </div>

        </form>
    </div>
</div>
