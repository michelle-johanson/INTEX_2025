<div class="page-container">
    <div class="page-card-form">
        <h2>Edit Event Occurrence</h2>

        <% if (typeof errors !== 'undefined' && Object.keys(errors).length > 0) { %>
            <div class="alert alert-danger">
                <p><strong>Please correct the following issues before submitting:</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <% for (const key in errors) { %>
                        <li><%= errors[key] %></li>
                    <% } %>
                </ul>
            </div>
        <% } %>

        <form action="/eventOccurrences/<%= occurrence.event_occurrence_id %>/edit" method="POST" class="form">

            <% 
                // 1. Determine if this request has formData from a failed submission
                const data = typeof formData !== 'undefined' && Object.keys(formData).length > 0 
                                ? formData 
                                : occurrence; 

                // 2. Format datetime-local correctly for browser input
                const formatDateTime = (key) => {
                    const dateString = data[key];
                    if (!dateString) return '';

                    if (typeof dateString === 'string' && dateString.includes('T')) {
                        return dateString;
                    }
                    const date = new Date(dateString);
                    if (isNaN(date)) return '';

                    return new Date(date.getTime() - (new Date().getTimezoneOffset() * 60000))
                            .toISOString()
                            .slice(0, 16);
                };

                // 3. Format date for YYYY-MM-DD input
                const formatDate = (key) => {
                    const dateString = data[key];
                    if (!dateString) return '';

                    if (typeof dateString === 'string' && dateString.length === 10) {
                        return dateString;
                    }
                    const date = new Date(dateString);
                    if (isNaN(date)) return '';

                    return date.toISOString().split('T')[0];
                };
            %>

            <!-- EVENT SELECT -->
            <label for="EventID">Event</label>
            <select id="EventID" 
                    name="EventID" 
                    required 
                    class="<%= errors.EventID ? 'input-error' : '' %>">

                <% events.forEach(e => { %>
                    <% const isSelected = String(e.event_id) === String(data.event_id); %>
                    <option value="<%= e.event_id %>" <%= isSelected ? "selected" : "" %>>
                        <%= e.name %> â€” <%= e.type %>
                    </option>
                <% }) %>
            </select>

            <% if (errors.EventID) { %>
                <p class="error-text"><%= errors.EventID %></p>
            <% } %>

            <!-- START DATETIME -->
            <label for="EventDateTimeStart">Start Date & Time</label>
            <input id="EventDateTimeStart"
                   type="datetime-local"
                   name="EventDateTimeStart"
                   value="<%= formatDateTime('starts_at') %>"
                   required 
                   class="<%= errors.StartsAt ? 'input-error' : '' %>" />

            <% if (errors.StartsAt) { %>
                <p class="error-text"><%= errors.StartsAt %></p>
            <% } %>

            <!-- END DATETIME -->
            <label for="EventDateTimeEnd">End Date & Time</label>
            <input id="EventDateTimeEnd"
                   type="datetime-local"
                   name="EventDateTimeEnd"
                   value="<%= formatDateTime('ends_at') %>"
                   class="<%= errors.EndsAt ? 'input-error' : '' %>" />

            <% if (errors.EndsAt) { %>
                <p class="error-text"><%= errors.EndsAt %></p>
            <% } %>

            <!-- LOCATION -->
            <label for="EventLocation">Location</label>
            <input id="EventLocation"
                   type="text"
                   name="EventLocation"
                   value="<%= data.location || '' %>"
                   required />

            <!-- CAPACITY -->
            <label for="EventCapacity">Capacity</label>
            <input id="EventCapacity"
                   type="number"
                   name="EventCapacity"
                   min="1"
                   value="<%= data.capacity || '' %>"
                   required 
                   class="<%= errors.EventCapacity ? 'input-error' : '' %>" />

            <% if (errors.EventCapacity) { %>
                <p class="error-text"><%= errors.EventCapacity %></p>
            <% } %>

            <!-- REGISTRATION DEADLINE -->
            <label for="EventRegistrationDeadline">Registration Deadline</label>
            <input id="EventRegistrationDeadline"
                   type="date"
                   name="EventRegistrationDeadline"
                   value="<%= formatDate('registration_deadline') %>"
                   required 
                   class="<%= errors.RegDeadline ? 'input-error' : '' %>" />

            <% if (errors.RegDeadline) { %>
                <p class="error-text"><%= errors.RegDeadline %></p>
            <% } %>

            <div class="btn-wrapper">
                <button class="btn btn-primary btn-lg">Save Changes</button>
                <a href="/eventOccurrences/<%= occurrence.event_occurrence_id %>" 
                   class="btn btn-secondary btn-lg">Cancel</a>
            </div>

        </form>
    </div>
</div>
