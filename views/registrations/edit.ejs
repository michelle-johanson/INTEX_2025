<div class="page-container">
    <div class="page-card-form">

        <h2 class="page-title">Edit Registration</h2>

        <!-- ERROR DISPLAY -->
        <% if (typeof errors !== 'undefined' && Object.keys(errors).length > 0) { %>
            <div class="alert alert-danger">
                <p><strong>Please correct the following issues:</strong></p>
                <ul style="padding-left: 20px; margin-bottom: 0;">
                    <% for (const key in errors) { %>
                        <li><%= errors[key] %></li>
                    <% }) %>
                </ul>
            </div>
        <% } %>

        <form action="/registrations/<%= registration.event_occurrence_id %>/<%= registration.participant_id %>/edit" 
              method="POST"
              class="form">

            <% 
                const data = (typeof formData !== 'undefined' && Object.keys(formData).length > 0)
                    ? formData 
                    : registration;

                const formatDateTime = (key) => {
                    const raw = data[key];
                    if (!raw) return "";

                    // If formData already contains the datetime (string), return as-is
                    if (typeof formData !== 'undefined' && formData[key] === raw) {
                        return raw;
                    }

                    const date = new Date(raw);
                    if (isNaN(date)) return "";

                    return new Date(date.getTime() - date.getTimezoneOffset() * 60000)
                        .toISOString()
                        .slice(0, 16);
                };
            %>

            <!-- META INFORMATION (EVENT + PARTICIPANT) -->
            <div class="detail-card" style="margin-bottom: 1.5rem;">
                <div class="detail-row">
                    <span class="detail-label">Event</span>
                    <span class="detail-value"><%= registration.event_name %></span>
                </div>

                <div class="detail-row">
                    <span class="detail-label">Participant</span>
                    <span class="detail-value">
                        <%= registration.first_name %> <%= registration.last_name %>
                    </span>
                </div>
            </div>

            <!-- STATUS -->
            <label for="RegistrationStatus">Status</label>
            <select id="RegistrationStatus" name="RegistrationStatus">
                <option value="Registered" <%= data.status === 'Registered' ? 'selected' : '' %>>
                    Registered
                </option>

                <option value="Waitlist" <%= data.status === 'Waitlist' ? 'selected' : '' %>>
                    Waitlist
                </option>

                <option value="Cancelled" <%= data.status === 'Cancelled' ? 'selected' : '' %>>
                    Cancelled
                </option>
            </select>

            <!-- Attended -->
            <input type="hidden" name="RegistrationAttendedFlag" value="off">

            <div class="checkbox-row">
                <input type="checkbox"
                       id="RegistrationAttendedFlag"
                       name="RegistrationAttendedFlag"
                       value="on"
                       <%= data.attended === true || data.RegistrationAttendedFlag === 'on' ? "checked" : "" %>
                />
                <label for="RegistrationAttendedFlag">Attended Event?</label>
            </div>

            <!-- CHECK-IN TIME -->
            <label for="RegistrationCheckInTime">Check-In Time</label>
            <input 
                id="RegistrationCheckInTime"
                type="datetime-local" 
                name="RegistrationCheckInTime"
                value="<%= formatDateTime('check_in_time') %>"
            />

            <!-- ACTION BUTTONS -->
            <div class="btn-wrapper">
                <button class="btn btn-primary btn-lg">Save Changes</button>

                <a href="/registrations/event/<%= registration.event_occurrence_id %>" 
                   class="btn btn-secondary btn-lg">
                    Cancel
                </a>
            </div>

        </form>
    </div>
</div>
