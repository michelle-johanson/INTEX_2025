<div class="page-container">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="page-title" style="margin-bottom: 0;">Registration Details</h1>
            <p class="text-muted"><%= registration.event_name %></p>
        </div>

        <% 
            const isManager = session.access_level && (session.access_level.toLowerCase() === "manager" || session.access_level.toLowerCase() === "admin");
            const isOwner = String(session.user_id) === String(registration.participant_id);

            // LOGIC: Determine where to send the user back to after actions
            // If Manager -> Back to Event Roster
            // If Participant -> Back to My Registrations List
            let returnPath = isManager 
                ? `/registrations/event/${registration.event_occurrence_id}`
                : `/registrations/participant/${registration.participant_id}`;
        %>

        <div class="d-flex gap-2">
            <!-- ADMIN ACTIONS -->
            <% if (isManager) { %>
                <a href="/registrations/<%= registration.event_occurrence_id %>/<%= registration.participant_id %>/edit" class="btn btn-warning">Edit Status</a>
                
                <form action="/registrations/<%= registration.event_occurrence_id %>/<%= registration.participant_id %>/delete" 
                      method="POST" 
                      onsubmit="return confirm('Are you sure?');"
                      style="display:inline;">
                    <!-- Pass return path to route -->
                    <input type="hidden" name="returnTo" value="<%= returnPath %>">
                    <button class="btn btn-danger">Delete</button>
                </form>
            
            <!-- PARTICIPANT ACTIONS (Self-Service) -->
            <% } else if (isOwner) { %>
                
                <% if (showSurveyButton) { %>
                    <!-- CASE 1: Attended -> Show Survey Button -->
                    <!-- Pass returnTo as query param so the Survey Form knows where to go next -->
                    <a href="/surveys/submit/<%= registration.event_occurrence_id %>?returnTo=<%= encodeURIComponent(returnPath) %>" 
                       class="btn btn-success btn-large">
                        Submit Survey
                    </a>

                <% } else if (hasSubmittedSurvey) { %>
                    <!-- CASE 2: Survey Done -->
                    <button class="btn btn-success" disabled>Survey Submitted</button>

                <% } else { %>
                    <!-- CASE 3: Standard Registration -> Allow Unregister -->
                    <% if (['registered', 'waitlist'].includes((registration.status || '').toLowerCase())) { %>
                        <form action="/registrations/unregister/<%= registration.event_occurrence_id %>" 
                              method="POST" 
                              onsubmit="return confirm('Are you sure you want to unregister from this event?');">
                            
                            <!-- Pass return path to route -->
                            <input type="hidden" name="returnTo" value="<%= returnPath %>">
                            <button class="btn btn-danger">Unregister</button>
                        </form>
                    <% } %>

                <% } %>

            <% } %>
        </div>
    </div>

    <!-- DETAIL CARD -->
    <div class="detail-card">
        <div class="detail-row">
            <span class="detail-label">Event</span>
            <span class="detail-value"><%= registration.event_name %></span>
        </div>

        <div class="detail-row">
            <span class="detail-label">Date & Time</span>
            <span class="detail-value">
                <%= new Date(registration.starts_at).toLocaleString() %>
            </span>
        </div>

        <div class="detail-row">
            <span class="detail-label">Location</span>
            <span class="detail-value"><%= registration.location %></span>
        </div>

        <div class="detail-row">
            <span class="detail-label">Participant</span>
            <span class="detail-value">
                <%= registration.first_name %> <%= registration.last_name %>
            </span>
        </div>

        <div class="detail-row">
            <span class="detail-label">Status</span>
            <span class="detail-value">
                <% if (registration.attended) { %>
                    <span class="badge bg-success" style="color: green; font-weight: bold;">Attended</span>
                <% } else { %>
                    <%= registration.status %>
                <% } %>
            </span>
        </div>

        <% if (registration.check_in_time) { %>
            <div class="detail-row">
                <span class="detail-label">Check-in Time</span>
                <span class="detail-value">
                    <%= new Date(registration.check_in_time).toLocaleTimeString() %>
                </span>
            </div>
        <% } %>
    </div>

    <div class="mt-4">
        <!-- Intelligent Back Button using the same logic -->
        <a href="<%= returnPath %>" class="btn btn-secondary">
            &larr; Back
        </a>
    </div>

</div>