<section class="page-container">
    <div class="page-card-wide">

        <!-- HEADER -->
        <div class="header-row">
            <div>
                <h2 class="page-title" style="margin-bottom: 0;">
                    Registration Details
                </h2>
                <p class="text-muted"><%= registration.event_name %></p>
            </div>

            <% 
                const isManager =
                    session.access_level &&
                    (session.access_level.toLowerCase() === "manager" ||
                     session.access_level.toLowerCase() === "admin");

                const isOwner = String(session.user_id) === String(registration.participant_id);

                // Decide where the user should return to
                const returnPath = isManager
                    ? `/registrations/event/${registration.event_occurrence_id}`
                    : `/registrations/participant/${registration.participant_id}`;
            %>

            <!-- ACTION BUTTONS -->
            <div class="btn-wrapper">

                <!-- ADMIN: Edit + Delete -->
                <% if (isManager) { %>

                    <a href="/registrations/<%= registration.event_occurrence_id %>/<%= registration.participant_id %>/edit" 
                       class="btn btn-edit btn-lg">
                        Edit Status
                    </a>

                    <form action="/registrations/<%= registration.event_occurrence_id %>/<%= registration.participant_id %>/delete"
                          method="POST"
                          onsubmit="return confirm('Are you sure you want to delete this registration?');">
                        <input type="hidden" name="returnTo" value="<%= returnPath %>">
                        <button class="btn btn-delete btn-lg">Delete</button>
                    </form>

                <% } else if (isOwner) { %>

                    <!-- PARTICIPANT: SURVEY / UNREGISTER -->

                    <% if (showSurveyButton) { %>

                        <a href="/surveys/submit/<%= registration.event_occurrence_id %>?returnTo=<%= encodeURIComponent(returnPath) %>" 
                           class="btn btn-primary btn-lg">
                            Submit Survey
                        </a>

                    <% } else if (hasSubmittedSurvey) { %>

                        <button class="btn btn-primary btn-lg" disabled>Survey Submitted</button>

                    <% } else if (['registered', 'waitlist'].includes((registration.status || '').toLowerCase())) { %>

                        <form action="/registrations/unregister/<%= registration.event_occurrence_id %>"
                              method="POST"
                              onsubmit="return confirm('Are you sure you want to unregister from this event?');">
                            <input type="hidden" name="returnTo" value="<%= returnPath %>">
                            <button class="btn btn-delete btn-lg">Unregister</button>
                        </form>

                    <% } %>

                <% } %>

            </div>
        </div>

        <!-- DETAILS -->
        <div class="detail-card">

            <div class="detail-row">
                <span class="detail-label">Event</span>
                <span class="detail-value"><%= registration.event_name %></span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Date & Time</span>
                <span class="detail-value">
                    <%= new Date(registration.starts_at).toLocaleString() %>
                </span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Location</span>
                <span class="detail-value"><%= registration.location %></span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Participant</span>
                <span class="detail-value">
                    <%= registration.first_name %> <%= registration.last_name %>
                </span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Status</span>
                <span class="detail-value">
                    <% if (registration.attended) { %>
                        <span class="badge bg-success" style="color: #0a0; font-weight: bold;">
                            Attended
                        </span>
                    <% } else { %>
                        <%= registration.status %>
                    <% } %>
                </span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Attended?</span>
                <span class="detail-value"><%= registration.attended ? "Yes" : "No" %></span>
            </div>

            <% if (registration.check_in_time) { %>
                <div class="detail-row">
                    <span class="detail-label">Check-In Time</span>
                    <span class="detail-value">
                        <%= new Date(registration.check_in_time).toLocaleTimeString() %>
                    </span>
                </div>
            <% } %>

            <div class="detail-row">
                <span class="detail-label">Registered On</span>
                <span class="detail-value">
                    <%= registration.created_at 
                        ? new Date(registration.created_at).toLocaleDateString() 
                        : 'N/A' %>
                </span>
            </div>

        </div>

        <!-- BACK BUTTON -->
        <div class="btn-wrapper" style="margin-top: 2rem;">
            <a href="<%= returnPath %>" class="btn btn-secondary btn-lg">‚Üê Back</a>
        </div>

    </div>
</section>
