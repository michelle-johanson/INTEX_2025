<div class="page-container">
<div class="page-card-wide">
    <h1 class="page-title">New Registration</h1>

    <!-- Assuming source IDs are passed via the GET route's query parameters -->
    <% 
        const sourceParticipantId = (typeof query !== 'undefined' && query.participant_id) ? query.participant_id : null;
        const sourceEventId = (typeof query !== 'undefined' && query.event_id) ? query.event_id : null;
    %>

    <form action="/registrations/new" method="POST" class="form">
        
        <!-- HIDDEN FIELDS TO CAPTURE SOURCE OF NAVIGATION -->
        <!-- These fields are critical for the POST route to redirect correctly -->
        <% if (sourceParticipantId) { %>
            <input type="hidden" name="SourceParticipantId" value="<%= sourceParticipantId %>">
        <% } %>
        <% if (sourceEventId) { %>
            <input type="hidden" name="SourceEventId" value="<%= sourceEventId %>">
        <% } %>


        <label for="EventOccurrenceID">Event Occurrence</label>
        <div class="select-wrapper">
            <select id="EventOccurrenceID" name="EventOccurrenceID" required>
                <option value="">Select an event...</option>
                <% occurrences.forEach(o=> { %>
                    <option value="<%= o.event_occurrence_id %>" <%=(typeof query !=='undefined' &&
                        query.event_occurrence_id==o.event_occurrence_id) ? 'selected' : '' %>>
                        <%= o.event_name %> - <%= new Date(o.starts_at).toLocaleString() %>
                    </option>
                    <% }) %>
            </select>
        </div>

        <label for="ParticipantID">Participant</label>
        <div class="select-wrapper">
            <select id="ParticipantID" name="ParticipantID" required>
                <option value="">Select a participant...</option>
                <% participants.forEach(p=> { %>
                    <option value="<%= p.participant_id %>" <%= sourceParticipantId && String(p.participant_id) === String(sourceParticipantId) ? 'selected' : '' %>>
                        <%= p.first_name %>
                            <%= p.last_name %> (<%= p.email %>)
                    </option>
                    <% }) %>
            </select>
        </div>

        <label for="RegistrationStatus">Status</label>
        <div class="select-wrapper">
            <select id="RegistrationStatus" name="RegistrationStatus">
                <option value="Registered">Registered</option>
                <option value="Waitlist">Waitlist</option>
                <option value="Cancelled">Cancelled</option>
            </select>
        </div>

        <div class="checkbox-row">
            <input type="checkbox" id="RegistrationAttendedFlag" name="RegistrationAttendedFlag">
            <label for="RegistrationAttendedFlag">Attended Event?</label>
        </div>

        <label for="RegistrationCreatedAt">Registration Date</label>
        <input type="date" name="RegistrationCreatedAt" value="<%= new Date().toISOString().split('T')[0] %>"
            required />

        <div class="form-actions">
            <button class="btn-submit">Create Registration</button>
            
            <!-- FIX: Dynamic Cancel Link -->
            <% 
                let cancelHref = '/registrations';
                if (sourceParticipantId) {
                    // Came from Participant list, go back there
                    cancelHref = `/registrations/participant/${sourceParticipantId}`;
                } else if (sourceEventId) {
                    // Came from Event detail page, go back there (View Registrants)
                    cancelHref = `/events/${sourceEventId}`; 
                }
            %>
            <a href="<%= cancelHref %>">Cancel</a>
        </div>

    </form>
</div>
</div>