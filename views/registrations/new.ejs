<div class="page-container">
    <div class="page-card-form">

        <h2 class="page-title">New Registration</h2>

        <% 
            const sourceParticipantId = (typeof query !== 'undefined' && query.participant_id) ? query.participant_id : null;
            const sourceEventId = (typeof query !== 'undefined' && query.event_id) ? query.event_id : null;
            const targetOccurrenceId = (typeof query !== 'undefined' && query.event_occurrence_id) ? query.event_occurrence_id : null;

            let occurrencesToShow = occurrences;
            if (targetOccurrenceId) {
                occurrencesToShow = occurrences.filter(o => String(o.event_occurrence_id) === String(targetOccurrenceId));
            }
        %>

        <form action="/registrations/new" method="POST" class="form">

            <!-- HIDDEN SOURCE FIELDS -->
            <% if (sourceParticipantId) { %>
                <input type="hidden" name="SourceParticipantId" value="<%= sourceParticipantId %>">
            <% } %>

            <% if (sourceEventId) { %>
                <input type="hidden" name="SourceEventId" value="<%= sourceEventId %>">
            <% } %>

            <!-- EVENT OCCURRENCE DROPDOWN -->
            <label for="EventOccurrenceID">Event Occurrence</label>
            <div class="select-wrapper">
                <select id="EventOccurrenceID" name="EventOccurrenceID" required>
                    <% if (!targetOccurrenceId) { %>
                        <option value="">Select an event...</option>
                    <% } %>

                    <% occurrencesToShow.forEach(o => { %>
                        <option value="<%= o.event_occurrence_id %>" 
                            <%= (String(o.event_occurrence_id) === String(targetOccurrenceId)) ? 'selected' : '' %>>
                            <%= o.event_name %> â€” <%= new Date(o.starts_at).toLocaleString() %>
                        </option>
                    <% }) %>
                </select>
            </div>

            <!-- PARTICIPANT DROPDOWN -->
            <label for="ParticipantID">Participant</label>
            <div class="select-wrapper">
                <select id="ParticipantID" name="ParticipantID" required>
                    <option value="">Select a participant...</option>

                    <% participants.forEach(p => { %>
                        <option value="<%= p.participant_id %>"
                            <%= sourceParticipantId && String(p.participant_id) === String(sourceParticipantId) ? "selected" : "" %>>
                            <%= p.first_name %> <%= p.last_name %> (<%= p.email %>)
                        </option>
                    <% }) %>
                </select>
            </div>

            <!-- STATUS -->
            <label for="RegistrationStatus">Status</label>
            <div class="select-wrapper">
                <select id="RegistrationStatus" name="RegistrationStatus">
                    <option value="Registered">Registered</option>
                    <option value="Waitlist">Waitlist</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>

            <!-- ATTENDED CHECKBOX -->
            <div class="checkbox-row">
                <input type="checkbox" id="RegistrationAttendedFlag" name="RegistrationAttendedFlag">
                <label for="RegistrationAttendedFlag">Attended Event?</label>
            </div>

            <!-- REGISTRATION DATE -->
            <label for="RegistrationCreatedAt">Registration Date</label>
            <input 
                id="RegistrationCreatedAt"
                type="date" 
                name="RegistrationCreatedAt" 
                value="<%= new Date().toISOString().split('T')[0] %>"
                required
            />

            <!-- ACTION BUTTONS -->
            <div class="btn-wrapper">

                <button class="btn btn-primary btn-lg">
                    Create Registration
                </button>

                <% 
                    let cancelHref = '/registrations';
                    
                    if (sourceParticipantId) {
                        cancelHref = `/registrations/participant/${sourceParticipantId}`;
                    } else if (sourceEventId) {
                        cancelHref = `/events/${sourceEventId}`;
                    } else if (targetOccurrenceId && occurrencesToShow.length > 0) {
                        cancelHref = `/events/${occurrencesToShow[0].event_id}`;
                    }
                %>

                <a href="<%= cancelHref %>" class="btn btn-secondary btn-lg">
                    Cancel
                </a>
            </div>

        </form>
    </div>
</div>
