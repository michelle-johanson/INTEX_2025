<section class="page-container">
    <div class="container-inner">

        <!-- HEADER -->
        <div class="container-header">
            <h1 class="page-title"><%= contextName || 'Event' %> Registrations</h1>
            <div class="heading-underline"></div>
        </div>

        <% 
            const isManager = session.access_level &&
                (session.access_level.toLowerCase() === "manager" ||
                 session.access_level.toLowerCase() === "admin");
        %>

        <!-- ADD REGISTRATION BUTTON (MANAGERS ONLY) -->
        <% if (isManager) { %>
            <% 
                const currentOccurrenceId = 
                    (typeof parentOccurrenceId !== 'undefined' && parentOccurrenceId)
                    ? parentOccurrenceId
                    : (registrations.length > 0 ? registrations[0].event_occurrence_id : '');
            %>

            <div class="btn-wrapper" style="margin-bottom: 1.5rem;">
                <a href="/registrations/new?event_occurrence_id=<%= currentOccurrenceId %>" 
                   class="btn btn-primary btn-small">
                    + Add Registration
                </a>
            </div>
        <% } %>

        <!-- EMPTY STATE -->
        <% if (!registrations || registrations.length === 0) { %>

            <p>No registrations found.</p>

        <% } else { %>

            <!-- TABLE -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Date</th>
                            <th>Participant</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        <% registrations.forEach(r => { %>
                            <tr>
                                <td><%= r.event_name %></td>

                                <td><%= new Date(r.starts_at).toLocaleDateString() %></td>

                                <td><%= r.first_name %> <%= r.last_name %></td>

                                <td>
                                    <% if (r.attended) { %>
                                        <span class="status-attended">Attended</span>
                                    <% } else { %>
                                        <%= r.status %>
                                    <% } %>
                                </td>

                                <td class="table-actions">

                                    <a href="/registrations/<%= r.event_occurrence_id %>/<%= r.participant_id %>"
                                       class="btn btn-outline btn-table">
                                        View
                                    </a>

                                    <% if (isManager) { %>

                                        <a href="/registrations/<%= r.event_occurrence_id %>/<%= r.participant_id %>/edit"
                                           class="btn btn-edit btn-table">
                                            Edit
                                        </a>

                                        <form action="/registrations/<%= r.event_occurrence_id %>/<%= r.participant_id %>/delete"
                                              method="POST"
                                        >
                                            <button class="btn btn-delete btn-table"
                                                    onclick="return confirm('Delete this registration?');">
                                                Delete
                                            </button>
                                        </form>

                                    <% } %>

                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

        <% } %>

        <!-- BACK BUTTON -->
        <div class="btn-wrapper" style="margin-top: 2rem;">
            <% if (typeof parentOccurrenceId !== 'undefined' && parentOccurrenceId) { %>
                <a href="/eventOccurrences/<%= parentOccurrenceId %>" 
                   class="btn btn-secondary btn-lg">
                    ← Back to Event Occurrence Details
                </a>
            <% } else { %>
                <a href="/registrations" 
                   class="btn btn-secondary btn-lg">
                    ← Back to Registrations Index
                </a>
            <% } %>
        </div>

    </div>
</section>
