<section class="page-container">
    <div class="container-inner">

        <!-- HEADER -->
        <div class="container-header">
            <h1 class="page-title"><%= contextName || 'Post-Event Surveys' %></h1>
            <div class="heading-underline"></div>
        </div>

        <% 
            const rawRole = session.access_level || session.role || (session.user && (session.user.access_level || session.user.role)) || "";
            const isManager = rawRole.toLowerCase() === "manager" || rawRole.toLowerCase() === "admin";

            // Level 3 (surveys for a specific occurrence):
            const targetId = typeof occurrence !== "undefined" && occurrence ? occurrence.event_occurrence_id : null;
        %>

        <!-- TABLE CONTROLS -->
        <div class="table-controls">

            <!-- Add Survey (Managers only, only on occurrence-level page) -->
            <% if (isManager && targetId) { %>
                <a href="/surveys/new?event_occurrence_id=<%= targetId %>" 
                   class="btn btn-primary btn-small">
                    + Add Survey Response
                </a>
            <% } else { %>
                <div></div>
            <% } %>

            <!-- SEARCH -->
            <form action="" method="GET" class="search-form">
                <input
                    type="text"
                    name="q"
                    placeholder="Search name or comments…"
                    value="<%= q || '' %>"
                >
                <button class="btn btn-secondary btn-small">Search</button>

                <% if (q) { %>
                    <a href="" class="search-clear-link">Clear</a>
                <% } %>
            </form>

        </div>

        <!-- EMPTY STATE -->
        <% if (!surveys || surveys.length === 0) { %>

            <p class="text-muted">No surveys found.</p>

        <% } else { %>

            <!-- SURVEY TABLE -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Date</th>
                            <th>Participant</th>
                            <th>Overall Score</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        <% surveys.forEach(s => { %>
                            <tr>
                                <td><%= s.event_name %></td>

                                <td><%= new Date(s.starts_at).toLocaleDateString() %></td>

                                <td>
                                    <%= s.first_name %> <%= s.last_name %>
                                </td>

                                <td>
                                    <!-- Star rating (active + inactive) -->
                                    <span class="rating-active">
                                        <%= "★".repeat(s.overall_score) %>
                                    </span>
                                    <span class="rating-inactive">
                                        <%= "★".repeat(5 - s.overall_score) %>
                                    </span>
                                    <span class="rating-small">(<%= s.overall_score %>)</span>
                                </td>

                                <td class="table-actions">
                                    <a href="/surveys/<%= s.event_occurrence_id %>/<%= s.participant_id %>" 
                                       class="btn btn-outline btn-table">
                                        View
                                    </a>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

        <% } %>

        <!-- BACK BUTTON FOR OCCURRENCE-LEVEL VIEW -->
        <% if (isManager && typeof occurrence !== "undefined" && occurrence) { %>
            <div class="btn-wrapper" style="margin-top: 2rem;">
                <a href="/surveys/type/<%= occurrence.event_id %>" 
                   class="btn btn-secondary btn-lg">
                    ← Back to <%= occurrence.event_name %> Occurrences
                </a>
            </div>
        <% } %>

    </div>
</section>
